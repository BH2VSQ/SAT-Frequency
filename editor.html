<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="appTitle">SAT Editor</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 默认样式：白天模式 */
        :root {
            --bg-body: #f1f5f9; /* slate-100 */
            --text-primary: #0f172a; /* slate-900 */
            --bg-card: #ffffff; /* white */
            --bg-header: #e2e8f0; /* slate-200 */
            --border-color: #cbd5e1; /* slate-300 */
            --bg-button: #3b82f6; /* blue-500 */
            --hover-button: #2563eb; /* blue-600 */
        }
        
        /* 黑夜模式的变量覆盖 */
        .dark-mode {
            --bg-body: #0f172a; /* slate-900 */
            --text-primary: #f1f5f9; /* slate-100 */
            --bg-card: #1e293b; /* slate-800 */
            --bg-header: #334155; /* slate-700 */
            --border-color: #475569; /* slate-600 */
            --bg-button: #60a5fa; /* blue-400 */
            --hover-button: #3b82f6; /* blue-500 */
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        .footer {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* 磁贴样式 */
        .sat-tile {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            transition: transform 0.2s, box-shadow 0.2s, background-color 0.3s, border-color 0.3s;
            cursor: pointer;
        }

        .sat-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        /* 模态框背景 */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }

        /* 文本域样式 */
        #jsonEditor {
            background-color: #f8fafc; /* light-mode: slate-50 */
            color: #1e293b; /* light-mode: slate-800 */
        }
        .dark-mode #jsonEditor {
            background-color: #0f172a; /* dark-mode: slate-900 */
            color: #e2e8f0; /* dark-mode: slate-200 */
        }
    </style>
</head>
<body class="transition-colors duration-300">
    <div id="app" class="min-h-screen p-4 md:p-8 transition-colors duration-300 max-w-7xl mx-auto">
        
        <!-- Header, Dark Mode Toggle and Export Button -->
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-slate-300 dark:border-slate-700">
            <h1 class="text-3xl font-extrabold text-gray-900 dark:text-gray-100">卫星 JSON 数据编辑器</h1>
            <div class="flex space-x-4">
                <button id="exportJsonButton" class="px-4 py-2 rounded-lg text-sm font-semibold text-white bg-green-600 hover:bg-green-700 shadow-md transition duration-200" disabled>
                    导出 JSON 文件
                </button>
                <button id="darkModeToggle" class="p-2 rounded-full bg-slate-200 dark:bg-slate-700 text-slate-800 dark:text-slate-200 shadow hover:shadow-md transition duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                </button>
            </div>
        </header>

        <!-- 卫星磁贴列表 -->
        <div id="satTileGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
            <!-- Tiles will be rendered here by JavaScript -->
            <div id="loadingMessage" class="text-center p-8 text-slate-500 dark:text-slate-400 col-span-full">正在加载 sat.json 文件...</div>
        </div>
        
    </div>

    <!-- 卫星编辑模态框 -->
    <div id="editModal" class="fixed inset-0 z-50 flex items-center justify-center hidden modal-overlay">
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col transition-all duration-300">
            <div class="p-6 border-b dark:border-slate-700 flex justify-between items-center">
                <h3 class="text-xl font-bold">编辑卫星数据: <span id="editingSatName" class="text-blue-600 dark:text-blue-400 font-mono"></span></h3>
                <button id="closeModalButton" class="p-2 text-slate-500 dark:text-slate-400 hover:text-red-500 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <div class="p-6 flex-grow overflow-y-auto">
                <label for="jsonEditor" class="block text-sm font-medium mb-2 dark:text-slate-300">
                    JSON 数据 (请确保格式正确):
                </label>
                <textarea id="jsonEditor" class="w-full h-80 p-3 rounded-lg border border-slate-300 dark:border-slate-600 text-sm resize-none font-mono" spellcheck="false"></textarea>
                <div id="editError" class="mt-2 text-red-500 text-sm hidden font-semibold"></div>
            </div>
            
            <div class="p-4 border-t dark:border-slate-700 flex justify-end space-x-3">
                <button id="cancelSaveButton" class="px-4 py-2 rounded-lg text-sm font-medium text-slate-700 dark:text-slate-300 bg-slate-200 dark:bg-slate-700 hover:bg-slate-300 dark:hover:bg-slate-600 transition duration-200">
                    取消
                </button>
                <button id="saveChangesButton" class="px-4 py-2 rounded-lg text-sm font-semibold text-white bg-blue-600 hover:bg-blue-700 shadow-md transition duration-200">
                    保存更改
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. 状态变量 ---
        let SAT_DATA = []; // 初始为空，等待 sat.json 加载
        let editingSatelliteId = null;

        // --- 2. 核心功能函数 ---

        /**
         * 异步加载 sat.json 文件
         */
        async function loadSatelliteData() {
            const loadingMessage = document.getElementById('loadingMessage');
            const exportButton = document.getElementById('exportJsonButton');

            try {
                // 尝试从同目录下的 sat.json 文件加载数据
                const response = await fetch('sat.json');
                
                if (!response.ok) {
                    throw new Error(`无法加载 sat.json: ${response.status} ${response.statusText}`);
                }
                
                // 解析 JSON 数据
                const data = await response.json();
                
                // 检查数据是否为数组
                if (!Array.isArray(data)) {
                    throw new Error("sat.json 内容格式错误，期望一个 JSON 数组。");
                }
                
                SAT_DATA = data;
                loadingMessage.remove(); // 移除加载提示
                exportButton.disabled = false; // 启用导出按钮
                renderSatTiles(); // 渲染磁贴
                
            } catch (error) {
                console.error("加载数据失败:", error);
                loadingMessage.innerHTML = `<span class="text-red-500">加载数据失败: ${error.message}</span>`;
                exportButton.disabled = true; // 禁用导出按钮
            }
        }

        /**
         * 渲染卫星磁贴列表
         */
        function renderSatTiles() {
            const grid = document.getElementById('satTileGrid');
            grid.innerHTML = ''; // 清空现有内容

            if (SAT_DATA.length === 0) {
                grid.innerHTML = '<div class="text-center p-8 text-slate-500 dark:text-slate-400 col-span-full">当前没有卫星数据。请确保 sat.json 文件存在且格式正确。</div>';
                return;
            }

            SAT_DATA.forEach(sat => {
                const transponderCount = sat.transponders ? sat.transponders.length : 0;
                
                const tile = document.createElement('div');
                tile.className = 'sat-tile rounded-xl p-5 shadow-lg flex flex-col justify-between';
                tile.setAttribute('data-sat-id', sat.id);

                tile.innerHTML = `
                    <div>
                        <div class="text-lg font-bold truncate">${sat.name}</div>
                        <div class="text-sm text-slate-500 dark:text-slate-400 mt-1">NORAD ID: ${sat.noradId || 'N/A'}</div>
                        <div class="mt-3 text-sm">
                            <span class="font-mono px-2 py-0.5 rounded-full text-xs font-semibold 
                                ${sat.orbitType === 'GEO' ? 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-300' : 'bg-teal-100 text-teal-800 dark:bg-teal-900 dark:text-teal-300'}">
                                ${sat.orbitType || 'N/A'}
                            </span>
                            <span class="ml-2 text-slate-600 dark:text-slate-300">${transponderCount} 个转发器</span>
                        </div>
                        <p class="text-xs text-slate-600 dark:text-slate-400 mt-2 line-clamp-2">${sat.notes || '无备注'}</p>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button class="edit-button px-3 py-1 text-sm rounded-lg font-medium text-white bg-blue-500 hover:bg-blue-600 transition duration-200 flex items-center space-x-1"
                                data-sat-id="${sat.id}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            <span>编辑</span>
                        </button>
                    </div>
                `;

                grid.appendChild(tile);
            });
            
            // 绑定编辑按钮事件
            document.querySelectorAll('.edit-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.stopPropagation(); // 防止事件冒泡到tile本身
                    openEditModal(e.currentTarget.getAttribute('data-sat-id'));
                });
            });
        }

        /**
         * 打开编辑模态框
         * @param {string} satelliteId - 要编辑的卫星ID
         */
        function openEditModal(satelliteId) {
            const modal = document.getElementById('editModal');
            const editor = document.getElementById('jsonEditor');
            const errorDiv = document.getElementById('editError');
            const satNameSpan = document.getElementById('editingSatName');
            
            const satellite = SAT_DATA.find(sat => sat.id === satelliteId);
            
            if (!satellite) {
                console.error("找不到卫星:", satelliteId);
                return;
            }

            editingSatelliteId = satelliteId;
            satNameSpan.textContent = satellite.name;
            
            // 将卫星对象美化为 JSON 字符串显示在编辑器中
            editor.value = JSON.stringify(satellite, null, 2);
            
            errorDiv.textContent = '';
            errorDiv.classList.add('hidden');
            modal.classList.remove('hidden');
        }
        
        /**
         * 关闭编辑模态框
         */
        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
            editingSatelliteId = null;
        }

        /**
         * 保存编辑器的内容到 SAT_DATA 数组中
         */
        function saveEdit() {
            const editor = document.getElementById('jsonEditor');
            const errorDiv = document.getElementById('editError');
            const jsonText = editor.value;

            try {
                // 尝试解析 JSON
                const newSatData = JSON.parse(jsonText);
                
                // 找到原数组中要替换的位置
                const index = SAT_DATA.findIndex(sat => sat.id === editingSatelliteId);
                
                if (index !== -1) {
                    // 替换原数据
                    SAT_DATA[index] = newSatData;
                    
                    // 成功保存后
                    closeModal();
                    renderSatTiles(); // 重新渲染磁贴列表
                } else {
                    throw new Error("保存失败：在数据集中找不到匹配的卫星ID。");
                }
            } catch (e) {
                // 显示错误信息
                errorDiv.textContent = `JSON 格式错误: ${e.message}`;
                errorDiv.classList.remove('hidden');
            }
        }

        /**
         * 导出当前的 SAT_DATA 为 JSON 文件
         */
        function exportJson() {
            if (SAT_DATA.length === 0) {
                 // 可以添加一个简单的提示机制，但这里我们遵循不使用 alert() 的原则，只是打印到控制台
                console.warn("当前没有数据可供导出。");
                return;
            }
            
            const jsonString = JSON.stringify(SAT_DATA, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sat.json'; // 导出为 sat.json 文件名
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        /**
         * 绑定事件监听器
         */
        function setupEventListeners() {
            // 模态框按钮
            document.getElementById('closeModalButton').addEventListener('click', closeModal);
            document.getElementById('cancelSaveButton').addEventListener('click', closeModal);
            document.getElementById('saveChangesButton').addEventListener('click', saveEdit);
            
            // JSON 导出按钮
            document.getElementById('exportJsonButton').addEventListener('click', exportJson);
        }

        // --- 3. 通用 UI 逻辑 (深色模式) ---
        function toggleDarkMode() {
            const isDarkMode = document.body.classList.toggle('dark-mode');
            localStorage.setItem('darkMode', isDarkMode ? 'enabled' : 'disabled');
            updateDarkModeIcon(isDarkMode);
        }

        function updateDarkModeIcon(isDarkMode) {
            const darkModeToggle = document.getElementById('darkModeToggle');
            darkModeToggle.innerHTML = isDarkMode
                ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.914A8.98 8.98 0 0110 18a9 9 0 01-9-9 8.98 8.98 0 014.086-7.293 8.977 8.977 0 0010.598 10.598z" /></svg>`
                : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`;
        }
        
        // --- 4. 启动 ---
        window.onload = function () {
            // Dark Mode Initialization
            const darkModeToggle = document.getElementById('darkModeToggle');
            darkModeToggle.addEventListener('click', toggleDarkMode);

            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const storedMode = localStorage.getItem('darkMode');
            
            let isInitialDarkMode = (storedMode === 'enabled' || (prefersDark && storedMode !== 'disabled'));

            if (isInitialDarkMode) {
                document.body.classList.add('dark-mode');
            }
            updateDarkModeIcon(isInitialDarkMode);
            
            // Initialize Application
            setupEventListeners();
            loadSatelliteData(); // 加载外部 JSON 文件
        };
    </script>
</body>
<footer><div class="footer"><a href="https://github.com/BH2VSQ/SAT-Frequency/">Github Project</a></div></footer>
</html>